<!DOCTYPE html>
<html lang="en" ng-app="madeIn" ng-init="$scope.search=false">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>MadeIn | Login</title>
    <script src="jquery3_1_1.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAWhZSLXVmqoQ1VLVTnSB1CwnR2_1E3uIo"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
    <!-- Google Identity Platform -->
    <meta name="google-signin-scope" content="profile email">
    <script src="https://apis.google.com/js/platform.js"></script>
    <meta name="google-signin-client_id" content="291473215081-56gt0ug8jsqqq942r7p2dgak4jhjt1q5.apps.googleusercontent.com">
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
  </head>
  <body ng-controller="mainController">
  <script>
        window.fbAsyncInit = function() {
	FB.init({
	  appId      : '562137460651599',
	  cookie     : true,
	  xfbml      : true,
	  version    : 'v2.8'
	});
	FB.AppEvents.logPageView();   
	FB.getLoginStatus(function(response) {
	    statusChangeCallback(response);
	});
      };
      
      function onSignIn(googleUser) {
        // Useful data for your client-side scripts:
        var profile = googleUser.getBasicProfile();
        console.log("ID: " + profile.getId()); // Don't send this directly to your server!
        console.log('Full Name: ' + profile.getName());
        console.log('Given Name: ' + profile.getGivenName());
        console.log('Family Name: ' + profile.getFamilyName());
        console.log("Image URL: " + profile.getImageUrl());
        console.log("Email: " + profile.getEmail());

        // The ID token you need to pass to your backend:
        var id_token = googleUser.getAuthResponse().id_token;
        console.log("ID Token: " + id_token);
        var xhr = new XMLHttpRequest();
	xhr.open('POST', 'http://localhost:3000/api/tokensignin');
	xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
	xhr.send('idtoken=' + id_token);
	console.log(xhr.responseText.length === 0);
	if (xhr.responseText['Registered'] === true) {
	  console.log("This user has been registered")
	} else if (xhr.responseText.length === 0) {
	  console.log("Authenticated");
	} else {
	  alert("Error in authentication");
	}
      };
      function signOut() {
	var auth2 = gapi.auth2.getAuthInstance();
	auth2.signOut().then(function () {
	  console.log('User signed out.');
	});
      }
      (function(d, s, id){
	var js, fjs = d.getElementsByTagName(s)[0];
	if (d.getElementById(id)) {return;}
	js = d.createElement(s); js.id = id;
	js.src = "//connect.facebook.net/en_US/sdk.js";
	fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));
      function checkLoginState() {
	FB.getLoginStatus(function(response) {
	if (response.status === 'connected') {
	  // the user is logged in and has authenticated your
	  // app, and response.authResponse supplies
	  // the user's ID, a valid access token, a signed
	  // request, and the time the access token 
	  // and signed request each expire
	  var uid = response.authResponse.userID;
	  var accessToken = response.authResponse.accessToken;
	  console.log("in");
	} else if (response.status === 'not_authorized') {
	  // the user is logged in to Facebook, 
	  console.log("sorta");
// 	  // but has not authenticated your app
	} else {
	  // the user isn't logged in to Facebook.
	  console.log("nope");
	}
	});
      }
      </script>
      <div id="fb-root"></div>
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="navbar-header">
                <a class="navbar-brand" href="#"><span class="made">made</span><span class="in">In</span></a>
            </div>
                <ul class="nav navbar-nav">
                <li class="active"><a href="index.html">Home</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="#"><span class="glyphicon glyphicon-log-in"></span>Login/Sign Up</a></li>
                </ul>
            </div>
        </nav>
        <div class="container">
            <div class="g-signin2" data-onsuccess="onSignIn" data-theme="dark" data-width="240" data-height="50"></div>
            <a href="#" onClick="signOut();">Sign Out</a> 
    
            <fb:login-button 
	    scope="public_profile,email"
	    onlogin="checkLoginState();">
	    </fb:login-button>
        </div>
    <script src="js/core.js"></script> <!-- load our main application -->
  </body>
</html>
